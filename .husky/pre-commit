#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-commit Hook f√ºr Qualit√§tssicherung
# F√ºhrt Code-Qualit√§ts-Checks vor jedem Commit aus

echo "üîç Running pre-commit quality checks..."

# 1. ESLint (mit Auto-Fix)
echo "üìù Running ESLint..."
pnpm lint --fix || {
  echo "‚ùå ESLint found errors. Please fix them before committing."
  exit 1
}

# 2. Prettier (Auto-Format)
echo "üíÖ Running Prettier..."
pnpm format || {
  echo "‚ùå Prettier formatting failed."
  exit 1
}

# 3. TypeScript Type-Check
echo "üî∑ Running TypeScript type check..."
pnpm type-check || {
  echo "‚ùå TypeScript type check failed. Please fix type errors before committing."
  exit 1
}

# 4. Check for TODO/FIXME in production code (Warnung, nicht blockierend)
echo "‚ö†Ô∏è  Checking for TODO/FIXME comments..."
TODOS=$(git diff --cached --name-only | grep -E '\.(ts|tsx|js|jsx)$' | xargs grep -l -E '(TODO|FIXME|XXX|HACK)' 2>/dev/null || true)
if [ -n "$TODOS" ]; then
  echo "‚ö†Ô∏è  WARNING: Found TODO/FIXME comments in staged files:"
  echo "$TODOS"
  echo "‚ö†Ô∏è  Consider addressing these before committing to production."
  # Nicht blockierend, nur Warnung
fi

# 5. Check for console.log in production code (Warnung)
echo "‚ö†Ô∏è  Checking for console.log statements..."
CONSOLE_LOGS=$(git diff --cached --name-only | grep -E '\.(ts|tsx|js|jsx)$' | xargs grep -l 'console\.log' 2>/dev/null || true)
if [ -n "$CONSOLE_LOGS" ]; then
  echo "‚ö†Ô∏è  WARNING: Found console.log statements in staged files:"
  echo "$CONSOLE_LOGS"
  echo "‚ö†Ô∏è  Consider using logger instead of console.log for production code."
  # Nicht blockierend, nur Warnung
fi

# 6. Plan-Validierung (wenn Plan-Dateien ge√§ndert wurden)
echo "üìã Checking plan changes..."
if git diff --cached --name-only | grep -q "\.cursor/plans/"; then
  echo "‚ö†Ô∏è  Plan-√Ñnderungen erkannt"
  echo ""
  echo "Bitte stelle sicher, dass:"
  echo "1. ‚úÖ Plan-√Ñnderungen dokumentiert sind"
  echo "2. ‚úÖ CHANGELOG.md aktualisiert ist"
  echo "3. ‚úÖ Code-√Ñnderungen im Plan reflektiert sind"
  echo ""
  
  # Pr√ºfe ob CHANGELOG aktualisiert wurde
  if ! git diff --cached --name-only | grep -q "CHANGELOG.md"; then
    echo "‚ö†Ô∏è  WARNUNG: CHANGELOG.md wurde nicht aktualisiert!"
    echo "Bitte aktualisiere .cursor/plans/CHANGELOG.md mit deinen √Ñnderungen."
    echo ""
    echo "M√∂chtest du trotzdem committen? (Dies ist nur eine Warnung)"
    # Nicht blockierend, nur Warnung
  fi
fi

echo "‚úÖ All pre-commit checks passed!"
exit 0













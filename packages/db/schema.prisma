// WattWeiser Platform - Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MULTI-TENANT
// ============================================

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  settings  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  areas            Area[]
  users            User[]
  knowledgeSpaces  KnowledgeSpace[]
  agents           Agent[]
  llmUsage         LLMUsage[]
  auditLogs        AuditLog[]
  customerAnalyses CustomerAnalysis[]
  profile          TenantProfile?
  channelSessions  ChannelSession[]
  characters       Character[]
  roles            Role[]
  sources          Source[]
  crawls           Crawl[]
  events           Event[]
  configs          Config?
  indices          Index[]
  kbArticles       KBArticle[]
  f13Config        F13Config?
  dashboards       Dashboard[]
  widgets          Widget[]
  alertRules       AlertRule[]
  alerts           Alert[]
  artifacts        Artifact[]

  @@index([slug])
}

model Area {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  teams  Team[]

  @@index([tenantId])
}

model Team {
  id        String   @id @default(uuid())
  areaId    String
  name      String
  createdAt DateTime @default(now())

  area Area @relation(fields: [areaId], references: [id], onDelete: Cascade)

  @@index([areaId])
}

// ============================================
// RBAC
// ============================================

model User {
  id           String   @id @default(uuid())
  tenantId     String
  email        String   @unique
  passwordHash String?
  keycloakId   String?  @unique
  mfaEnabled   Boolean  @default(false)
  mfaSecret    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userRoles UserRole[]
  agentRuns AgentRun[]
  auditLogs AuditLog[]
  chats     Chat[]
  feedback  Feedback[]

  @@index([tenantId])
  @@index([email])
}

model Role {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  permissions Json     @default("[]")
  createdAt   DateTime @default(now())

  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userRoles UserRole[]

  @@index([tenantId])
}

model UserRole {
  userId String
  roleId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model Permission {
  id       String @id @default(uuid())
  name     String @unique
  resource String
  action   String

  @@index([resource, action])
}

// ============================================
// KNOWLEDGE SPACES & RAG
// ============================================

model KnowledgeSpace {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  settings    Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  documents Document[]

  @@index([tenantId])
}

model Document {
  id               String   @id @default(uuid())
  knowledgeSpaceId String
  filePath         String
  fileName         String
  fileType         String?
  fileSize         BigInt
  metadata         Json     @default("{}")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  knowledgeSpace KnowledgeSpace @relation(fields: [knowledgeSpaceId], references: [id], onDelete: Cascade)
  chunks         Chunk[]

  @@index([knowledgeSpaceId])
  @@index([filePath])
}

model Chunk {
  id         String                       @id @default(uuid())
  documentId String
  content    String                       @db.Text
  chunkIndex Int
  metadata   Json                         @default("{}")
  embedding  Unsupported("vector(1536)")? // pgvector
  createdAt  DateTime                     @default(now())

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  // Note: pgvector index created via migration

  @@index([documentId])
}

// ============================================
// AGENTS
// ============================================

model Agent {
  id             String   @id @default(uuid())
  tenantId       String
  characterId    String? // MVP: Verknüpfung zu Character
  personaId      String? // MVP: Verknüpfung zu Persona
  name           String
  role           String // MVP: Rolle des Agents
  roleType       String
  tools          String[] // MVP: Tool-IDs
  ragConfig      Json? // MVP: RAG-Konfiguration
  personaConfig  Json     @default("{}")
  toolsConfig    Json     @default("[]")
  policiesConfig Json     @default("{}")
  kpiConfig      Json     @default("{}")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  character        Character?        @relation(fields: [characterId], references: [id], onDelete: Cascade)
  persona          Persona?          @relation(fields: [personaId], references: [id], onDelete: SetNull)
  agentRuns        AgentRun[]
  agentGenerations AgentGeneration[]

  @@index([tenantId])
  @@index([characterId])
  @@index([personaId])
  @@index([roleType])
}

model AgentRun {
  id          String    @id @default(uuid())
  agentId     String
  userId      String?
  input       String    @db.Text
  output      String?   @db.Text
  status      String // pending | running | completed | failed
  metrics     Json      @default("{}")
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  agent     Agent      @relation(fields: [agentId], references: [id], onDelete: Cascade)
  user      User?      @relation(fields: [userId], references: [id], onDelete: SetNull)
  toolCalls ToolCall[]

  @@index([agentId])
  @@index([userId])
  @@index([status])
}

model ToolCall {
  id         String   @id @default(uuid())
  agentRunId String
  toolName   String
  input      Json
  output     Json?
  error      String?  @db.Text
  createdAt  DateTime @default(now())

  agentRun AgentRun @relation(fields: [agentRunId], references: [id], onDelete: Cascade)

  @@index([agentRunId])
}

// ============================================
// CHARACTERS
// ============================================

model Character {
  id               String   @id @default(uuid())
  tenantId         String // Tenant-Zuordnung für MVP
  role             String // Nicht mehr unique, da pro Tenant
  name             String? // Extrahierter Name aus Prompt
  personality      Json? // LLM-generierte Persönlichkeit
  agent            String   @default("chatbot")
  voiceId          String?
  voiceModel       String?
  systemPrompt     String?  @db.Text
  prompt           String   @db.Text // Original-Prompt für Charakter-Definition
  customParameters Json     @default("{}")
  knowledgeBase    Json     @default("{}")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tenant        Tenant?        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conversations Conversation[]
  artifacts     Artifact[]
  personas      Persona[]
  agents        Agent[]
  widgets       Widget[]

  @@unique([tenantId, role]) // Unique pro Tenant
  @@index([tenantId])
  @@index([role])
}

model Artifact {
  id          String   @id @default(uuid())
  tenantId    String // Für Multi-Tenant Support
  characterId String?
  sourceId    String?
  name        String
  description String?  @db.Text
  url         String   @db.Text
  hash        String? // Content-Hash für Delta-Detection
  storageType String   @default("local") // local | s3 | url
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  character Character? @relation(fields: [characterId], references: [id], onDelete: Cascade)
  source    Source?    @relation(fields: [sourceId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([characterId])
  @@index([sourceId])
  @@index([hash])
  @@index([url])
}

// ============================================
// CHAT / CONVERSATIONS
// ============================================

model Chat {
  id        String   @id @default(uuid())
  userId    String
  tenantId  String
  title     String?
  metadata  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([userId])
  @@index([tenantId])
}

model Conversation {
  id          String   @id @default(uuid())
  threadId    String   @unique @default(uuid())
  sessionId   String? // Session-ID für Tracking
  characterId String?
  userId      String?
  tenantId    String?
  userAgent   String?  @db.Text
  startedAt   DateTime @default(now())
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  character Character?            @relation(fields: [characterId], references: [id], onDelete: SetNull)
  messages  ConversationMessage[]

  @@index([characterId])
  @@index([userId])
  @@index([tenantId])
  @@index([threadId])
  @@index([sessionId])
  @@index([startedAt])
}

model ConversationMessage {
  id             String   @id @default(uuid())
  conversationId String
  role           String // user | assistant | system
  content        String   @db.Text
  citations      Json?
  latencyMs      Int? // Latenz in Millisekunden
  sourcesJsonb   Json? // Quellen als JSON Array
  metadata       Json     @default("{}")
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
}

model Message {
  id        String   @id @default(uuid())
  chatId    String
  role      String // user | assistant | system
  content   String   @db.Text
  citations Json? // Array of Citation objects
  metadata  Json     @default("{}")
  createdAt DateTime @default(now())

  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId])
  @@index([createdAt])
}

// ============================================
// LLM USAGE & COSTS
// ============================================

model LLMUsage {
  id               String   @id @default(uuid())
  tenantId         String
  provider         String
  model            String
  promptTokens     Int
  completionTokens Int
  totalTokens      Int
  costUsd          Decimal  @db.Decimal(10, 6)
  createdAt        DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([createdAt])
  @@index([provider])
}

// ============================================
// AUDIT LOGS
// ============================================

model AuditLog {
  id           String   @id @default(uuid())
  tenantId     String
  userId       String?
  service      String? // Service-Name für Observability
  action       String
  resourceType String?
  resourceId   String?
  details      Json     @default("{}")
  metadata     Json     @default("{}") // Zusätzliche Metadaten für Logs
  ipAddress    String?
  userAgent    String?  @db.Text
  timestamp    DateTime @default(now()) // Alias für createdAt für Observability
  createdAt    DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([action])
  @@index([service, createdAt(sort: Desc)])
}

// ============================================
// FEEDBACK
// ============================================

model Feedback {
  id        String   @id @default(uuid())
  userId    String
  type      String // rating | comment | improvement
  content   String?  @db.Text
  rating    Int? // 1-5 stars
  metadata  Json     @default("{}")
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
}

// ============================================
// CUSTOMER INTELLIGENCE
// ============================================

model CustomerAnalysis {
  id           String    @id @default(uuid())
  tenantId     String
  customerType String // "kommune" | "unternehmen" | "organisation"
  analysisType String // "initial" | "periodic" | "on-demand"
  status       String // "pending" | "running" | "completed" | "failed"
  metadata     Json      @default("{}")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  completedAt  DateTime?

  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  targetGroups     TargetGroup[]
  personas         Persona[]
  agentGenerations AgentGeneration[]

  @@index([tenantId])
  @@index([status])
  @@index([customerType])
}

model TargetGroup {
  id                 String   @id @default(uuid())
  analysisId         String
  name               String
  description        String?  @db.Text
  demographics       Json     @default("{}") // Alter, Geschlecht, Standort, etc.
  behaviorPatterns   Json     @default("{}") // Interaktionen, Präferenzen
  language           String // "de" | "en" | "tr" | etc.
  contentPreferences Json     @default("{}") // Bevorzugte Content-Typen
  size               Int? // Geschätzte Größe der Zielgruppe
  confidence         Float    @default(0.0) // 0.0 - 1.0
  createdAt          DateTime @default(now())

  analysis           CustomerAnalysis    @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  personas           Persona[]
  contentEnrichments ContentEnrichment[]
  agentGenerations   AgentGeneration[]

  @@index([analysisId])
  @@index([language])
  @@index([confidence])
}

model Persona {
  id                 String   @id @default(uuid())
  characterId        String? // MVP: Verknüpfung zu Character
  analysisId         String?
  targetGroupId      String?
  name               String
  description        String?  @db.Text
  traits             Json     @default("{}") // Persona-Eigenschaften (MVP)
  characteristics    Json     @default("{}") // Persönlichkeitsmerkmale, Bedürfnisse
  painPoints         Json     @default("[]") // Herausforderungen
  goals              Json     @default("[]") // Ziele
  communicationStyle Json     @default("{}") // Bevorzugter Kommunikationsstil
  language           String // "de" | "en" | "tr" | etc.
  metadata           Json     @default("{}")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  character        Character?        @relation(fields: [characterId], references: [id], onDelete: Cascade)
  analysis         CustomerAnalysis? @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  targetGroup      TargetGroup?      @relation(fields: [targetGroupId], references: [id], onDelete: SetNull)
  agentGenerations AgentGeneration[]
  agents           Agent[]

  @@index([characterId])
  @@index([analysisId])
  @@index([targetGroupId])
  @@index([language])
}

model ContentEnrichment {
  id             String   @id @default(uuid())
  targetGroupId  String
  sourceType     String // "crawler" | "document" | "conversation" | "external"
  sourceId       String // ID des Quell-Dokuments/Conversations/etc.
  content        String   @db.Text
  relevanceScore Float    @default(0.0) // 0.0 - 1.0
  language       String
  metadata       Json     @default("{}")
  createdAt      DateTime @default(now())

  targetGroup TargetGroup @relation(fields: [targetGroupId], references: [id], onDelete: Cascade)

  @@index([targetGroupId])
  @@index([sourceType, sourceId])
  @@index([relevanceScore])
}

model AgentGeneration {
  id               String    @id @default(uuid())
  analysisId       String
  personaId        String?
  targetGroupId    String?
  agentId          String? // ID des generierten Agents
  generationConfig Json      @default("{}") // Konfiguration für Agent-Generierung
  status           String // "pending" | "generating" | "completed" | "failed"
  error            String?   @db.Text
  createdAt        DateTime  @default(now())
  completedAt      DateTime?

  analysis    CustomerAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  persona     Persona?         @relation(fields: [personaId], references: [id], onDelete: SetNull)
  targetGroup TargetGroup?     @relation(fields: [targetGroupId], references: [id], onDelete: SetNull)
  agent       Agent?           @relation(fields: [agentId], references: [id], onDelete: SetNull)

  @@index([analysisId])
  @@index([personaId])
  @@index([targetGroupId])
  @@index([agentId])
  @@index([status])
}

// ============================================
// TENANT PROFILE
// ============================================

model TenantProfile {
  id         String   @id @default(uuid())
  tenantId   String   @unique
  market     String // "enterprise" | "gov" | "media" | "health"
  mode       String // "standard" | "regulated" | "gov-f13"
  providers  Json     @default("{}") // { llm: "wattweiser" | "f13", ... }
  compliance Json     @default("{}") // { gdpr: boolean, aiAct: boolean, ... }
  features   Json     @default("{}") // { guidedFlows: boolean, sourceRequired: boolean, ... }
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([market])
  @@index([mode])
}

// ============================================
// CHANNEL SESSIONS
// ============================================

model ChannelSession {
  id        String    @id @default(uuid())
  tenantId  String
  channel   String // "web-chat" | "phone" | "whatsapp" | "telegram"
  channelId String // Channel-spezifische ID (z.B. WhatsApp Number, Phone Number)
  userId    String?
  metadata  Json      @default("{}")
  status    String    @default("active") // "active" | "closed" | "paused"
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  closedAt  DateTime?

  tenant   Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messages ChannelMessage[]

  @@index([tenantId, channel])
  @@index([channelId])
}

model ChannelMessage {
  id        String   @id @default(uuid())
  sessionId String
  direction String // "inbound" | "outbound"
  type      String // "text" | "audio" | "media"
  content   String?  @db.Text
  audioUrl  String?
  mediaUrl  String?
  metadata  Json     @default("{}")
  createdAt DateTime @default(now())

  session ChannelSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt(sort: Desc)])
}

// ============================================
// MVP MODELS: SOURCES, CRAWLS, EVENTS, CONFIGS, INDICES
// ============================================

model Source {
  id        String   @id @default(uuid())
  tenantId  String
  url       String   @db.Text
  type      String // "domain" | "pattern" | "file"
  enabled   Boolean  @default(true)
  metadata  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  artifacts Artifact[]
  crawls    Crawl[]

  @@index([tenantId])
  @@index([url])
  @@index([enabled])
}

model Crawl {
  id         String    @id @default(uuid())
  tenantId   String
  sourceId   String?
  startedAt  DateTime  @default(now())
  finishedAt DateTime?
  pages      Int       @default(0)
  delta      Int       @default(0) // Anzahl neuer/geänderter Seiten
  status     String // "pending" | "running" | "completed" | "failed"
  log        String?   @db.Text
  metadata   Json      @default("{}")
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  source Source? @relation(fields: [sourceId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([sourceId])
  @@index([status])
  @@index([startedAt])
  @@index([tenantId, status]) // Composite index für häufige Queries
  @@index([createdAt(sort: Desc)]) // Für Sortierung nach neuesten Crawls
}

model Event {
  id             String   @id @default(uuid())
  tenantId       String
  conversationId String?
  sessionId      String?
  type           String // "viseme" | "tts" | "error" | "kpi"
  payloadJsonb   Json // Event-spezifische Daten
  ts             DateTime @default(now())
  metadata       Json     @default("{}")
  createdAt      DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([conversationId])
  @@index([sessionId])
  @@index([type])
  @@index([ts])
  @@index([tenantId, type, ts(sort: Desc)]) // Composite index für Event-Queries
  @@index([conversationId, ts(sort: Desc)]) // Für Conversation-Event-Historie
}

model Config {
  tenantId  String   @id
  jsonb     Json // No-Code Config als JSON
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model Index {
  id         String   @id @default(uuid())
  tenantId   String
  name       String
  statsJsonb Json     @default("{}") // Statistiken (Anzahl Dokumente, Größe, etc.)
  metadata   Json     @default("{}")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([name])
}

// ============================================
// KNOWLEDGE BASE ARTICLES
// ============================================

model KBArticle {
  id          String    @id @default(uuid())
  tenantId    String
  title       String
  content     String    @db.Text
  category    String?
  tags        String[]
  status      String    @default("draft") // draft | published | archived
  publishedAt DateTime?
  metadata    Json      @default("{}")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@index([category])
  @@index([tenantId, status])
}

// ============================================
// F13 CONFIGURATION
// ============================================

model F13Config {
  id            String   @id @default(uuid())
  tenantId      String   @unique
  baseUrl       String
  apiKey        String?
  timeout       Int      @default(30000)
  retryAttempts Int      @default(3)
  retryDelay    Int      @default(1000)
  enabled       Boolean  @default(true)
  metadata      Json     @default("{}")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([enabled])
}

// ============================================
// DASHBOARDS
// ============================================

model Dashboard {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  layout      Json     @default("{}") // Dashboard Layout Configuration
  isDefault   Boolean  @default(false)
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  widgets Widget[]

  @@index([tenantId])
  @@index([isDefault])
  @@index([tenantId, isDefault])
}

// ============================================
// WIDGETS
// ============================================

model Widget {
  id          String   @id @default(uuid())
  tenantId    String
  dashboardId String?
  characterId String?
  type        String // overview | metrics | chart | table | custom
  name        String
  config      Json     @default("{}") // Widget Configuration
  position    Json     @default("{}") // Position in Dashboard (x, y, w, h)
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  dashboard Dashboard? @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  character Character? @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([dashboardId])
  @@index([characterId])
  @@index([type])
}

// ============================================
// ALERT RULES
// ============================================

model AlertRule {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  condition   Json // Alert Condition Configuration
  severity    String   @default("medium") // low | medium | high | critical
  enabled     Boolean  @default(true)
  actions     Json     @default("[]") // Actions to take when alert triggers
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  alerts Alert[]

  @@index([tenantId])
  @@index([enabled])
  @@index([severity])
  @@index([tenantId, enabled])
}

// ============================================
// ALERTS
// ============================================

model Alert {
  id             String    @id @default(uuid())
  tenantId       String
  ruleId         String
  title          String
  message        String    @db.Text
  severity       String // low | medium | high | critical
  status         String    @default("open") // open | acknowledged | resolved | closed
  acknowledgedAt DateTime?
  resolvedAt     DateTime?
  closedAt       DateTime?
  metadata       Json      @default("{}")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  tenant Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  rule   AlertRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([ruleId])
  @@index([status])
  @@index([severity])
  @@index([tenantId, status])
  @@index([createdAt(sort: Desc)])
}

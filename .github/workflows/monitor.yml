name: Log Analysis & Monitoring

on:
  schedule:
    - cron: '0 * * * *' # StÃ¼ndlich
    - cron: '0 0 * * *' # TÃ¤glich um Mitternacht
  workflow_run:
    workflows: ["Deploy to Staging", "Deploy to Production"]
    types:
      - completed
  workflow_dispatch:

jobs:
  collect-logs:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Railway CLI
        run: npm install -g @railway/cli
      
      - name: Authenticate Railway
        run: |
          echo "${{ secrets.RAILWAY_TOKEN }}" | railway login || \
          railway login --token "${{ secrets.RAILWAY_TOKEN }}" || \
          export RAILWAY_TOKEN="${{ secrets.RAILWAY_TOKEN }}" && railway whoami || \
          echo "âš ï¸ Railway authentication failed, but continuing..."
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        continue-on-error: true
      
      - name: Collect Railway logs
        run: |
          mkdir -p logs
          chmod +x scripts/log-analyzer.sh || true
          ./scripts/log-analyzer.sh collect || true
      
      - name: Upload logs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: railway-logs-${{ github.run_id }}
          path: logs/
          retention-days: 7

  analyze-logs:
    runs-on: ubuntu-latest
    needs: collect-logs
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download logs
        uses: actions/download-artifact@v4
        with:
          name: railway-logs-${{ github.run_id }}
          path: logs/
      
      - name: Analyze logs
        run: |
          chmod +x scripts/log-analyzer.sh || true
          ./scripts/log-analyzer.sh analyze logs/ || true
      
      - name: Detect errors
        run: |
          chmod +x scripts/log-analyzer.sh || true
          ./scripts/log-analyzer.sh detect-errors logs/ || true
      
      - name: Generate report
        run: |
          chmod +x scripts/log-analyzer.sh || true
          ./scripts/log-analyzer.sh report logs/ > log-report.md || true
      
      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: log-analysis-report-${{ github.run_id }}
          path: log-report.md
          retention-days: 30
      
      - name: Create GitHub Issue for critical errors
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let report = 'No report available';
            try {
              report = fs.readFileSync('log-report.md', 'utf8');
            } catch (e) {
              report = 'Error reading report file';
            }
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Critical Errors Detected - ${new Date().toISOString()}`,
              body: `Critical errors were detected in the logs.\n\n## Report\n\n\`\`\`\n${report}\n\`\`\`\n\nPlease investigate immediately.`,
              labels: ['monitoring', 'error', 'critical']
            })

  performance-metrics:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Railway CLI
        run: npm install -g @railway/cli
        continue-on-error: true
      
      - name: Authenticate Railway
        run: |
          echo "${{ secrets.RAILWAY_TOKEN }}" | railway login || \
          railway login --token "${{ secrets.RAILWAY_TOKEN }}" || \
          export RAILWAY_TOKEN="${{ secrets.RAILWAY_TOKEN }}" && railway whoami || \
          echo "âš ï¸ Railway authentication failed, but continuing..."
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        continue-on-error: true
      
      - name: Collect performance metrics
        run: |
          chmod +x scripts/log-analyzer.sh || true
          ./scripts/log-analyzer.sh metrics || true
        continue-on-error: true
      
      - name: Generate daily report
        if: github.event.schedule == '0 0 * * *'
        run: |
          chmod +x scripts/log-analyzer.sh || true
          ./scripts/log-analyzer.sh daily-report > daily-report.md || true
      
      - name: Create daily report issue
        if: github.event.schedule == '0 0 * * *'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let report = 'No report available';
            try {
              report = fs.readFileSync('daily-report.md', 'utf8');
            } catch (e) {
              report = 'Daily performance report';
            }
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“Š Daily Performance Report - ${new Date().toISOString().split('T')[0]}`,
              body: `## Daily Performance Report\n\n\`\`\`\n${report}\n\`\`\``,
              labels: ['monitoring', 'report', 'performance']
            })








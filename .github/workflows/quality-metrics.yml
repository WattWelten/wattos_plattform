name: Quality Metrics

on:
  schedule:
    - cron: '0 4 * * *' # T√§glich um 4 Uhr morgens
  workflow_dispatch:
  push:
    branches: [main, develop]

jobs:
  calculate-metrics:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run linting
        run: pnpm lint || true
        continue-on-error: true
      
      - name: Run type-check
        run: pnpm type-check || true
        continue-on-error: true
      
      - name: Run tests with coverage
        run: pnpm test:unit --coverage || true
        continue-on-error: true
      
      - name: Calculate quality metrics
        run: |
          chmod +x scripts/calculate-quality-metrics.sh || true
          ./scripts/calculate-quality-metrics.sh || echo "‚ö†Ô∏è Quality metrics calculation failed"
        continue-on-error: true  # Non-blocking f√ºr Wait for CI
      
      - name: Upload metrics
        uses: actions/upload-artifact@v4
        with:
          name: quality-metrics
          path: docs/QUALITY_METRICS.md
          retention-days: 90
      
      - name: Create GitHub Issue if quality score < 60
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const metricsPath = 'docs/QUALITY_METRICS.md';
            
            if (!fs.existsSync(metricsPath)) {
              return;
            }
            
            const metrics = fs.readFileSync(metricsPath, 'utf8');
            const scoreMatch = metrics.match(/Overall Quality Score:\s+(\d+)\/100/);
            
            if (scoreMatch && parseInt(scoreMatch[1]) < 60) {
              const title = 'üî¥ Code Quality Score Below Threshold';
              const body = `Code quality score is below the threshold of 60.
              
              **Current Score:** ${scoreMatch[1]}/100
              
              Please review the quality metrics and address the issues.
              
              See: \`docs/QUALITY_METRICS.md\`
              
              This issue was auto-generated by the quality metrics workflow.`;
              
              // Pr√ºfe ob Issue bereits existiert
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'code-quality',
              });
              
              const existingIssue = issues.data.find(issue => issue.title === title);
              
              if (!existingIssue) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: title,
                  body: body,
                  labels: ['code-quality', 'automated', 'critical'],
                });
              }
            }
      
      - name: Summary
        if: always()
        run: |
          echo "## Quality Metrics Summary" >> $GITHUB_STEP_SUMMARY
          if [ -f "docs/QUALITY_METRICS.md" ]; then
            echo "‚úÖ Quality metrics calculated" >> $GITHUB_STEP_SUMMARY
            echo "üìä See docs/QUALITY_METRICS.md for details" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è  Quality metrics calculation failed" >> $GITHUB_STEP_SUMMARY
          fi








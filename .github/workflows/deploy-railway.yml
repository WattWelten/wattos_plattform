name: Deploy to Railway

on:
  push:
    branches:
      - main
      - production
    paths:
      - 'apps/**'
      - 'packages/**'
      - 'scripts/**'
      - '.github/workflows/deploy-railway.yml'
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy (leave empty for all)'
        required: false
        type: string
      environment:
        description: 'Environment (production, staging)'
        required: true
        type: choice
        options:
          - production
          - staging
      skip_validation:
        description: 'Skip pre-deployment validation'
        required: false
        type: boolean
        default: false
      skip_health_check:
        description: 'Skip post-deployment health checks'
        required: false
        type: boolean
        default: false

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  NODE_VERSION: '20'

jobs:
  # Job 1: Pre-Deployment Validierung
  validate:
    name: Pre-Deployment Validation
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_validation != 'true'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Authenticate Railway
        run: |
          echo "${{ secrets.RAILWAY_TOKEN }}" | railway login
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      
      - name: Run Pre-Deployment Validation
        run: |
          chmod +x scripts/validate-pre-deployment.sh
          ./scripts/validate-pre-deployment.sh ${{ github.event.inputs.environment || 'production' }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  # Job 2: Railway Configs generieren
  generate-configs:
    name: Generate Railway Configs
    runs-on: ubuntu-latest
    needs: [validate]
    if: always() && (needs.validate.result == 'success' || github.event.inputs.skip_validation == 'true')
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      
      - name: Generate Railway Configurations
        run: |
          chmod +x scripts/generate-railway-configs.sh
          ./scripts/generate-railway-configs.sh
      
      - name: Upload Generated Configs
        uses: actions/upload-artifact@v4
        with:
          name: railway-configs
          path: |
            apps/**/railway.json
            apps/services/**/railway.json
          retention-days: 1

  # Job 3: Service URLs synchronisieren (vor Deployment)
  sync-urls-pre:
    name: Sync Service URLs (Pre-Deploy)
    runs-on: ubuntu-latest
    needs: [generate-configs]
    if: always()
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Authenticate Railway
        run: |
          echo "${{ secrets.RAILWAY_TOKEN }}" | railway login
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      
      - name: Sync Service URLs
        run: |
          chmod +x scripts/sync-service-urls.sh
          ./scripts/sync-service-urls.sh ${{ github.event.inputs.environment || 'production' }} || true
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        continue-on-error: true

  # Job 4: Services deployen (Matrix-Strategy fÃ¼r parallele Deployments)
  deploy-services:
    name: Deploy Services
    runs-on: ubuntu-latest
    needs: [generate-configs, sync-urls-pre]
    if: always() && (needs.generate-configs.result == 'success')
    strategy:
      fail-fast: false
      matrix:
        include:
          # Priority 1 Services (kritisch, zuerst)
          - service: api-gateway
            priority: 1
          - service: llm-gateway
            priority: 1
          # Priority 2 Services (wichtig)
          - service: tool-service
            priority: 2
          - service: rag-service
            priority: 2
          - service: chat-service
            priority: 2
          - service: agent-service
            priority: 2
          # Priority 3 Services (optional)
          - service: customer-intelligence-service
            priority: 3
          - service: crawler-service
            priority: 3
          - service: voice-service
            priority: 3
          # Priority 4 Services (optional)
          - service: admin-service
            priority: 4
          - service: character-service
            priority: 4
          - service: summary-service
            priority: 4
          - service: feedback-service
            priority: 4
          - service: avatar-service
            priority: 4
          - service: ingestion-service
            priority: 4
          - service: metaverse-service
            priority: 5
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Railway Configs
        uses: actions/download-artifact@v4
        with:
          name: railway-configs
          path: .
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Authenticate Railway
        run: |
          echo "${{ secrets.RAILWAY_TOKEN }}" | railway login
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      
      - name: Link Railway Project
        run: |
          PROJECT_ID="${{ secrets.RAILWAY_PROJECT_ID }}"
          if [ -z "$PROJECT_ID" ]; then
            PROJECT_ID="a97f01bc-dc80-4941-b911-ed7ebb3efa7a"
          fi
          railway link "$PROJECT_ID" || true
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        continue-on-error: true
      
      - name: Deploy ${{ matrix.service }}
        if: github.event.inputs.service == '' || github.event.inputs.service == matrix.service || github.event_name == 'push'
        run: |
          echo "ðŸš€ Deploying ${{ matrix.service }} (Priority: ${{ matrix.priority }})"
          
          # Finde Service-Verzeichnis
          SERVICE_PATH=$(find . -type d -path "*/${{ matrix.service }}" | head -1)
          if [ -z "$SERVICE_PATH" ]; then
            echo "âš ï¸ Service-Verzeichnis nicht gefunden, verwende Root"
            SERVICE_PATH="."
          fi
          
          # Wechsle zum Service-Verzeichnis und deploye
          cd "$SERVICE_PATH"
          railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        working-directory: ${{ github.workspace }}

  # Job 5: Service URLs synchronisieren (nach Deployment)
  sync-urls-post:
    name: Sync Service URLs (Post-Deploy)
    runs-on: ubuntu-latest
    needs: [deploy-services]
    if: always()
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Authenticate Railway
        run: |
          echo "${{ secrets.RAILWAY_TOKEN }}" | railway login
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      
      - name: Wait for Services to Start
        run: echo "â³ Waiting 60s for services to start..." && sleep 60
      
      - name: Sync Service URLs
        run: |
          chmod +x scripts/sync-service-urls.sh
          ./scripts/sync-service-urls.sh ${{ github.event.inputs.environment || 'production' }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        continue-on-error: true

  # Job 6: Post-Deployment Health Checks
  health-check:
    name: Post-Deployment Health Check
    runs-on: ubuntu-latest
    needs: [sync-urls-post]
    if: always() && github.event.inputs.skip_health_check != 'true'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Authenticate Railway
        run: |
          echo "${{ secrets.RAILWAY_TOKEN }}" | railway login
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      
      - name: Install jq and curl
        run: sudo apt-get update && sudo apt-get install -y jq curl
      
      - name: Wait for Services to be Ready
        run: echo "â³ Waiting 90s for services to be fully ready..." && sleep 90
      
      - name: Run Health Checks
        run: |
          chmod +x scripts/post-deployment-health-check.sh
          ./scripts/post-deployment-health-check.sh ${{ github.event.inputs.environment || 'production' }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        continue-on-error: true

  # Job 7: Deployment Summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-services, health-check]
    if: always()
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Generate Deployment Summary
        run: |
          echo "## ðŸš€ Railway Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Pre-Deployment Validation: ${{ needs.validate.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Config Generation: ${{ needs.generate-configs.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Service Deployment: ${{ needs.deploy-services.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Health Checks: ${{ needs.health-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Monitor services: \`railway logs --service <service-name>\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Check health: \`./scripts/post-deployment-health-check.sh ${{ github.event.inputs.environment || 'production' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "3. View service status: \`railway service <service-name>\`" >> $GITHUB_STEP_SUMMARY
